<html>
	<head>

		<!-- DataTables Begin-->
		<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/r/bs-3.3.5/jq-2.1.4,dt-1.10.9,b-1.0.3,fh-3.0.0,se-1.0.1/datatables.min.css"/>
		<script type="text/javascript" src="//cdn.datatables.net/r/bs-3.3.5/jq-2.1.4,dt-1.10.9,b-1.0.3,fh-3.0.0,se-1.0.1/datatables.min.js"></script>
		<!-- DataTables End -->

		<link rel="stylesheet" type="text/css" href="/static/style.css">

		<style type="text/css">
/*		blue:#192857
		gold:#cdb87d*/
			input, select {
				border: 2px solid #cdb87d !important;
				border-radius: 5px !important;
			}
			input:invalid {
				border:1px solid red;
			}
			input {
				color: #192857;
				outline: none;
    			-webkit-appearance: none;
			}
			input:focus, select:focus {
				border: 2px solid #cdb87d;
			    border-collapse: separate;
			    box-shadow: 0 0 7px #cdb87d;
			}
			input.amount {
				text-align: center;
				width: 50px;
			}
			#container { 
				margin:auto;
				padding-bottom: 50px;
				width:90%;
			}
			#tblBeers {
				color: #cdb87d;
			}
			#tblBeers th {
				background-color: #cdb87d;
				color: #192857;
			}
			.dataTables_wrapper {
				color: #cdb87d;
			}
			#tblBeers tr {
				background-color: rgba(25,40,87,0);
			}
			#tblBeers .odd {
				background-color: rgba(0,0,0,.5);
			}
			#tblBeers .even {
				background-color: rgba(0,0,0,.1);
			}#tblBeers tr.selected {
			    background-color: rgba(205,184,125,.4);
			}
			table.dataTable thead .sorting:after, table.dataTable thead .sorting_asc:after, table.dataTable thead .sorting_desc:after, table.dataTable thead .sorting_asc_disabled:after, table.dataTable thead .sorting_desc_disabled:after {
				opacity: 0.8;
			}
			table.dataTable thead .sorting:after {
			    opacity: 0.3;
			}
			.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
				border-top: 1px solid #cdb87d;
			}
			.table>thead>tr>th {
				border-bottom: 2px solid #cdb87d;
			}
			.pagination>.disabled>a, .pagination>.disabled>a:focus, .pagination>.disabled>a:hover, .pagination>.disabled>span, .pagination>.disabled>span:focus, .pagination>.disabled>span:hover {
				background-color: #f0ead9;
				border-color: #cdb87d;
			}
			.pagination>li>a, .pagination>li>span {
				color: #192857;
			    background-color: #cdb87d;
			    border: 1px solid #cdb87d;
			}
			.pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hover {
				color: #cdb87d;
			    background-color: #192857;
			    border-color: #cdb87d;
			}
			.pagination>li>a:focus, .pagination>li>a:hover, .pagination>li>span:focus, .pagination>li>span:hover {
			    color: #192857;
			    background-color: #b79a46;
			    border-color: #cdb87d;
			}
			table.dataTable.fixedHeader-floating, table.dataTable.fixedHeader-locked {
    			background-color: #cdb87d;
    		}
    			table.fixedHeader-floating input {
    				border-color:#192857;
    			}
			/*tfoot { display: table-header-group; }
			thead { display: table-footer-group; }*/
		</style>
	</head>

	<body bgcolor = "#002d62">
		<a class="header" href="home">
			<h1>university of pittsburgh <br> beer delivery<img src="/static/cathedal.png" alt="Picture of Cathedral" style="width:90px;height:90px;"></h1>
		</a>

		<p>Below is a list of available beers:<br><br></p>

		<div id="container">
			{% if beers %}
			<table id="tblBeers" class="table " cellspacing="0" width="100%">
				<thead>
					<tr>
						<th>BREWERY</th>
						<th>PRODUCT</th>
						<th>STYLE</th>
						<th>ABV</th>
						<th>PRICE</th>
						<th>CART</th>
					</tr>
					<tr id="filterrow">
						<th></th>
						<th></th>
						<th></th>
						<th></th>
						<th></th>
						<th></th>
					</tr>
				</thead>
				<tfoot>
					<tr>
						<th>BREWERY</th>
						<th>PRODUCT</th>
						<th>STYLE</th>
						<th>ABV</th>
						<th>PRICE</th>
						<th></th>
					</tr>
				</tfoot>
				<tbody>
					{% for beer in beers %}
					<tr>
						<td>{{ beer.brewery }}</td>
						<td>{{ beer.product }}</td>
						<td>{{ beer.style }}</td>
						<td>{{ beer.abv }}%</td>
						<td id="price-{{beer.id}}">${{ beer.price }}</td>
						<td>
							<input id="num-{{beer.id}}" class="amount" type="number" min="0" max="12" maxlength="2" pattern='[0-9]{2}' value="0">
							<input type="button" onclick="addToCart('{{beer.id}}')" value="Add">
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			{% endif %}
		</div>
	</body>

	<script type="text/javascript">

		//////////////////////////////////////////////
		// Use this function so that we can abstract 
		//		any support for older browsers into the 
		//		details.
		//////////////////////////////////////////////
		function createXmlHttp() {
		//////////////////////////////////////////////
			var xmlhttp;

			if (window.XMLHttpRequest) {
				xmlhttp = new XMLHttpRequest();
			} else {
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			}
			
			if (!(xmlhttp)) {
				alert("Your browser does not support AJAX!");
			}
			
			return xmlhttp;
		}


		//////////////////////////////////////////////
		// Use the given xmlHttp object to send the 
		//		given parameters to the target URL. The
		//		parameters should be a URL formatted string.
		//////////////////////////////////////////////
		function postParameters(xmlHttp, target, parameters) {
		//////////////////////////////////////////////
			if (xmlHttp) {
				xmlHttp.open("POST",target,true);
				xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xmlHttp.send(parameters);
			}
		}


		//////////////////////////////////////////////
		// Adds the given beer ID to the user's shopping
		//		cart by using an AJAX request and submitting
		//		the necessary data to a method on the server
		//		side. Uses a ReadyState to handle the AJAX request.
		//
		//		The readystate has the following values:
		// 
		//	0 = request not initialized 
		//	1 = server connection established
		//	2 = request received 
		//	3 = processing request 
		//	4 = request finished and response is ready
		//
		//	Also, we could check status. 200 is ok; other codes may be errors (like 404).
		//////////////////////////////////////////////
		function addToCart(beerID) {
		//////////////////////////////////////////////
			// the beerID is also the ID of the input
			//		boxes that we want to grab
			var num = $("#num-"+beerID).val();

			var price = $("#price-"+beerID).html();
			price = Number(price.replace(/[^0-9\.]+/g,""));

			var total = num*price;

			// create our beer object for the shopping cart
			var item = {
				id = beerID,
				amount = num,
				price = price,
				total = total
			}

			// create a DTO (data transfer object), which is
			//		a normalized version of the above object
			//		that is able to be used between different
			//		languages (php, c++, python, etc)
			var dto = JSON.stringify(item);

			// AJAX call here to update the user's cart 
			//		within the DB
			var xmlHttp = createXmlHttp();

			xmlHttp.onreadystatechange=function() {
				if(xmlHttp.readyState == 4) {
					// parse the response back into a js object
					var response = JSON.parse(xmlHttp.responseText);
					
					//var d = document.getElementById('texthere');
					var text = '';

					for (var i = 0; i < myObject.length; i++) {
						text += response[i].first_name + ' ' + response[i].last_name + '<br>';
					}

					//d.innerHTML = text;
				}
			}

			// post our DTO back to the server to be used
			//		to update the user's database (shopping cart)
			postParameters(xmlHttp, '/addToCart', dto);
		}


		//////////////////////////////////////////////
		// Will reset all of the dropdown filters the
		//		user might have set on the beer table.
		//////////////////////////////////////////////
		function resetAllFilters() {
		//////////////////////////////////////////
			$("#filterrow select").each(function() {
				$(this).prop("selectedIndex",0).trigger("change");
			})

			// reset the search box
			$("#tblBeers_filter input").val("").trigger("keyup");
		}


		//////////////////////////////////////////////
		$(document).ready(function() {
		//////////////////////////////////////////////
		    var table = $('#tblBeers').DataTable( {
		    	fixedHeader: true,
		    	lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
		    	orderCellsTop: true,
		    	pageLength: 25,
		    	responsive: true,
		    	rowId: "ID",
		    	select: 'single',
		    	aoColumnDefs: [
		          { 'bSortable': false, 'aTargets': [5] }
		        ],
		    	language: {
		    		"info": "Showing _START_ to _END_ of _TOTAL_ beers",
		    		"search": "Quick search:"
		    	},
		    	initComplete: function () {
		            this.api().columns().every( function () {
		                var column = this;
		                var num = column[0][0] + 1; // remove zero-base
		                var name = $(column.header()).html(); // get name of column

		                if (name!=="PRODUCT" && name!=="ABV" && name!=="CART") {
			                var select = $('<select class="input-sm"><option value=""></option></select>')
			                    .appendTo( $('#filterrow th:nth-child(' + num + ')').empty() )
			                    .on( 'change', function () {
			                        var val = $.fn.dataTable.util.escapeRegex(
			                            $(this).val()
			                        );
			 
			                        column
			                            .search( val ? '^'+val+'$' : '', true, false )
			                            .draw();
			                    } );
			 
			                column.data().unique().sort().each( function ( d, j ) {
			                    select.append( '<option value="'+d+'">'+d+'</option>' )
			                } );
		                }

		                if (name==="CART") {
		                	$("<input type='button' onclick='resetAllFilters()' value='Reset Filters'>")
			                    .appendTo( $('#filterrow th:nth-child(' + num + ')').empty() );
		                }
		            } );
		        }
			} );
		});
	</script>
</html>
