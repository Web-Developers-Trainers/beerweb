<html>

<link rel="stylesheet" type="text/css" href="/static/style.css">
<head>
		<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/r/bs-3.3.5/jq-2.1.4,dt-1.10.9,b-1.0.3,fh-3.0.0,se-1.0.1/datatables.min.css"/>
		<script type="text/javascript" src="//cdn.datatables.net/r/bs-3.3.5/jq-2.1.4,dt-1.10.9,b-1.0.3,fh-3.0.0,se-1.0.1/datatables.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/static/style.css">

<style>
	#map {
        width: 100%;
        height: 400px;
    }
	input, select {
		border: 2px solid #cdb87d !important;
		border-radius: 5px !important;
	}
	input:invalid {
		border:1px solid red;
	}
	input {
		color: #192857;
		font-size: 2em;
		height: 50px;
		outline: none;
		-webkit-appearance: none;
		width: 600px;
	}
	input:focus, select:focus {
		border: 2px solid #cdb87d;
	    border-collapse: separate;
	    box-shadow: 0 0 7px #cdb87d;
	}
	h2 {
		font-size: 30px;
	}
	input[type=button] {
		width: 50px;
	}
#container { 
				margin:auto;
				margin-top:15px;
				padding-bottom: 50px;
				width:90%;
			}
			#tblBeers {
				color: #cdb87d;
			}
			#tblBeers th {
				background-color: #cdb87d;
				color: #192857;
			}
			.dataTables_wrapper {
				color: #cdb87d;
			}
			#tblBeers tr {
				background-color: rgba(25,40,87,0);
			}
			#tblBeers .odd {
				background-color: rgba(0,0,0,.5);
			}
			#tblBeers .even {
				background-color: rgba(0,0,0,.1);
			}#tblBeers tr.selected {
			    background-color: rgba(205,184,125,.4);
			}
			table.dataTable thead .sorting:after, table.dataTable thead .sorting_asc:after, table.dataTable thead .sorting_desc:after, table.dataTable thead .sorting_asc_disabled:after, table.dataTable thead .sorting_desc_disabled:after {
				opacity: 0.8;
			}
			table.dataTable thead .sorting:after {
			    opacity: 0.3;
			}
			.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
				border-top: 1px solid #cdb87d;
			}
			.table>thead>tr>th {
				border-bottom: 2px solid #cdb87d;
			}
			.pagination>.disabled>a, .pagination>.disabled>a:focus, .pagination>.disabled>a:hover, .pagination>.disabled>span, .pagination>.disabled>span:focus, .pagination>.disabled>span:hover {
				background-color: #f0ead9;
				border-color: #cdb87d;
			}
			.pagination>li>a, .pagination>li>span {
				color: #192857;
			    background-color: #cdb87d;
			    border: 1px solid #cdb87d;
			}
			.pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hover {
				color: #cdb87d;
			    background-color: #192857;
			    border-color: #cdb87d;
			}
			.pagination>li>a:focus, .pagination>li>a:hover, .pagination>li>span:focus, .pagination>li>span:hover {
			    color: #192857;
			    background-color: #b79a46;
			    border-color: #cdb87d;
			}
			table.dataTable.fixedHeader-floating, table.dataTable.fixedHeader-locked {
    			background-color: #cdb87d;
    		}
    			table.fixedHeader-floating input {
    				border-color:#192857;
    			}
</style>
<script src="https://maps.googleapis.com/maps/api/js"></script>
<script>
// we use this function so that we can abstract any support for older 
// browsers into the details.
function createXmlHttp() {
	var xmlhttp;
	if (window.XMLHttpRequest) {
		xmlhttp = new XMLHttpRequest();
	} else {
		xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
	}
	if (!(xmlhttp)) {
		alert("Your browser does not support AJAX!");
	}
	return xmlhttp;
}

// use the given xmlHttp object to send the given parameters to the 
// target URL.  parameters should be a URL formatted string.
function postParameters(xmlHttp, target, parameters) {
	if (xmlHttp) {
		xmlHttp.open("POST",target,true);
		xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xmlHttp.send(parameters);
	}
}

function handleKeyUp() {
	var address = document.getElementById("addressTxt").value;
	var result = document.getElementById("addressResult");
	if (!address) {
		result.innerHTML = "";
		return;
	}
	var xmlHttp = createXmlHttp();
	xmlHttp.onreadystatechange=function() {
		if (xmlHttp.readyState == 4) {
			//result.innerHTML = "To " + address + "<br>";
			
			var mapObject = JSON.parse(xmlHttp.responseText);
			//window.alert("response " + mapObject.toString());
			if (mapObject) {
				result.innerHTML = mapObject.destination_addresses[0] + "<br>"
				if (mapObject.rows[0].elements[0].status == "OK") {
					var distance = price = Number(mapObject.rows[0].elements[0].distance.text.replace(/[^0-9\.]+/g,""));
					result.innerHTML += mapObject.rows[0].elements[0].distance.text + ", ";
					result.innerHTML += mapObject.rows[0].elements[0].duration.text + "<br>";

					if (distance && distance < 5) {
						result.innerHTML += '<span style="color:green;">Hey great news... WE DELIVER BEER TO YOU!!!</span>';
					} else {
						result.innerHTML += '<span style="color:red;">Sorry to say this, but you are outside of our delivery range :(</span>';
					}
				} else {
					result.innerHTML = "No results found";
				}
			} else {
				result.innerHTML = "Not found";
			}
		} else {
			// response not ready
			result.innerHTML = "Searching...";
		}
	}
	postParameters(xmlHttp, "/getdistance?address=" + address.replace(/\s+/g, ''), "");
}

function initialize() {
  var myLatLng = {lat: 40.4442, lng: -79.9531};
 
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 14,
    center: myLatLng
  });
 
  var marker = new google.maps.Marker({
    position: myLatLng,
    map: map,
    title: 'Cathedral of Learning'
  });
}



google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>
<body>
	<a class="header" href="home">
		<h1>university of pittsburgh <br> beer delivery<img src="/static/cathedal.png" alt="Picture of Cathedral" style="width:90px;height:90px;"></h1>
	</a>	

	<div style="margin:0 auto; text-align:center;">
		<input type="text" id="addressTxt" placeholder="Please enter your address..." onkeyup="handleKeyUp();">
	</div>

	<br>
	
	<h2 id="addressResult">Your address must be within a 5 mile radius of the university</h2>

	<div id="map"></div>

	{% if beers %}
	<div id="container">
		<table id="tblBeers" class="table " cellspacing="0" width="100%">
			<thead>
				<tr>
					<th>BREWERY</th>
					<th>PRODUCT</th>
					<th>PRICE</th>
					<th>QUANTITY</th>
				</tr>
			</thead>
			<!--<tfoot>
				<tr>
					<th>BREWERY</th>
					<th>PRODUCT</th>
					<th>STYLE</th>
					<th>ABV</th>
					<th>PRICE</th>
					<th></th>
				</tr>
			</tfoot>-->
			<tbody>
				{% for beer in beers %}
				<tr>
					<td>{{ beer.brewery }}</td>
					<td>{{ beer.product }}</td>
					<td id="price-{{ beer.beerid }}">${{ beer.price }}</td>
					<td id="quant-{{ beer.beerid }}">{{ beer.quantity }}</td>
					<td>
						<input type="button" onclick="removeFromCart('{{beer.beerid}}')" value="X">
					</td>
				</tr>
				{% endfor %}
			</tbody>
			<tfoot>
					<tr>
						<th>Total</th>
						<th></th>
						<th></th>
						<th id="totalprice">{{ total }}</th>
					</tr>
				</tfoot>
		</table>
	</div>
	{% endif %}
</body>
<script>
//////////////////////////////////////////////
		$(document).ready(function() {
		//////////////////////////////////////////////
		    var table = $('#tblBeers').DataTable( {
		    	fixedHeader: true,
		    	lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
		    	orderCellsTop: true,
		    	pageLength: 25,
		    	responsive: true,
		    	rowId: "ID",
		    	select: 'single',
		    	aoColumnDefs: [
		          { 'bSortable': false, 'aTargets': [5] }
		        ],
		    	language: {
		    		"info": "Showing _START_ to _END_ of _TOTAL_ beers",
		    		"search": "Quick search:"
		    	},
		    	initComplete: function () {
		            this.api().columns().every( function () {
		                var column = this;
		                var num = column[0][0] + 1; // remove zero-base
		                var name = $(column.header()).html(); // get name of column

		                if (name!=="PRODUCT" && name!=="ABV" && name!=="CART") {
			                var select = $('<select class="input-sm"><option value=""></option></select>')
			                    .appendTo( $('#filterrow th:nth-child(' + num + ')').empty() )
			                    .on( 'change', function () {
			                        var val = $.fn.dataTable.util.escapeRegex(
			                            $(this).val()
			                        );
			 
			                        column
			                            .search( val ? '^'+val+'$' : '', true, false )
			                            .draw();
			                    } );
			 
			                column.data().unique().sort().each( function ( d, j ) {
			                    select.append( '<option value="'+d+'">'+d+'</option>' )
			                } );
		                }

		                if (name==="CART") {
		                	$("<input type='button' onclick='resetAllFilters()' value='Reset Filters'>")
			                    .appendTo( $('#filterrow th:nth-child(' + num + ')').empty() );
		                }
		            } );
		        }
			} );
		});

		//////////////////////////////////////////////
		// Removes the given beer ID to the cart
		//////////////////////////////////////////////
		function removeFromCart(beerID) {
		//////////////////////////////////////////////
			// the beerID is also the ID of the input
			//		boxes that we want to grab

			var price = $("#price-"+beerID).html();
			price = Number(price.replace(/[^0-9\.]+/g,""));
			quantity = parseInt($("#quant-"+beerID).html());
			$("#quant-"+beerID).html("0");

			totalprice = parseFloat($("#totalprice").html())
			totalprice = totalprice - parseFloat(price * quantity)
			$("#totalprice").html(totalprice.toString())


			// some kind of AJAX call here to update
			//		the user's cart within the DB

			var xmlHttp = createXmlHttp()
			xmlHttp.onreadystatechange=function() {
				if (xmlHttp.readyState == 4) {
					//Some kind of feedback here
				}
			}

			postParameters(xmlHttp, '/removeFromCart', JSON.stringify({'beerID':beerID}))
		}
</script>
</html>
